name: Publish wiki
on:
  push:
    branches: [main]
    paths:
      - wiki/**
      - .github/workflows/publish-wiki.yml
concurrency:
  group: publish-wiki
  cancel-in-progress: true
permissions:
  contents: write
jobs:
  publish-wiki:
    runs-on: ubuntu-latest
    steps:
      # Pulls repo
      - uses: actions/checkout@v3
  
      # Installs gomarkdoc
      - name: Install gomarkdoc
        run: go install github.com/princjef/gomarkdoc/cmd/gomarkdoc@latest
      
      # Generates wiki with gomarkdoc
      - name: Generate Wiki Documentation
        run: |
          rm -rf wiki/* 
          mkdir -p wiki
          for dir in $(go list -f '{{.Dir}}' ./... | grep -v "cmd"); do
          gomarkdoc --output "./wiki/$(basename $dir).md" $dir
          done
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git diff --exit-code || (git commit -am "Formatted code" && git push)

          # Pushes wiki folder to wiki repo
      - uses: Andrew-Chen-Wang/github-wiki-action@v4
